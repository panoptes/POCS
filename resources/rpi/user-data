#cloud-config
# https://cloudinit.readthedocs.io/

hostname: pocs-control

# Override ntp with chrony configuration on Ubuntu
ntp:
  enabled: true
  ntp_client: chrony
  servers:
    - time1.google.com
    - time2.google.com
    - time3.google.com
    - time4.google.com

# If you have set up ssh on github you can pull down your
# key automatically so that you can log into the unit without
# a password. Change 'CHANGEME' to your username below.
ssh_import_id:
  #  - gh:your_github_id
  - gh:panoptes

# Setting "expire: true" will force a password change on first login.
chpasswd:
  expire: true
  list:
    - panoptes:panoptes

ssh_pwauth: yes

# New groups to create.
groups:
  - panoptes
  - docker

users:
  - name: panoptes
    gecos: PANOPTES User
    primary_group: panoptes
    groups: users, admin, dialout, plugdev, docker, i2c, input, gpio, panoptes
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    lock_passwd: false
    shell: /bin/zsh

## Update apt database and upgrade packages on first boot
package_update: true
package_upgrade: true

byobu: enable

## Install additional packages on first boot.
packages:
  - ack
  - apt-transport-https
  - byobu
  - ca-certificates
  - chrony
  - ctop
  - docker-clean
  - docker-compose
  #  - docker-io
  - git
  - htop
  - httpie
  - jq
  - neovim
  - software-properties-common
  - speedometer
  - vim-nox
  - watchdog
  - zsh


write_files:
  # Allow panoptes user to mount via sshfs.
  - content: |
      user_allow_other
    path: /etc/fuse.conf
    append: true

## Get and run the install script upon first boot.
runcmd:
  # Oh my zsh
  - [ sh, -c, "$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)", "", "--unattended" ]
  - chsh /bin/zsh
  - [ git, clone, "https://github.com/zsh-users/zsh-autosuggestions", "${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions" ]
  - sed -i 's/\(git\)/\(git sudo zsh-autosuggestions dotenv\)/g' /home/panoptes/.zshrc
  - echo "export LANG=en_US.UTF-8" >> /home/panoptes/.zshrc
  - echo "unsetopt share_history" >> /home/panoptes/.zshrc
  # POCS & friends.
  - sudo mkdir -p /var/panoptes/scripts
  - sudo chown -R panoptes /var/panoptes
  # Anaconda via mini-forge.
  - wget -q "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-$(uname -m).sh" -O "/var/panoptes/scripts/install-miniforge.sh"
  - sh "/var/panoptes/scripts/install-miniforge.sh" -b -f -p "/var/panoptes/conda"
  - /var/panoptes/conda/bin/conda init zsh bash
  # Append some statements to .zshrc
  - echo "export PROMPT='%F{240}%n%F{red}@%F{green}%m:%F{101}%d$ %F{reset}'" >> /home/panoptes/.zshrc
  - echo "\n# POCS" >> /home/panoptes/.zshrc
  - echo "export PANDIR=/var/panoptes" >> /home/panoptes/.zshrc
  - echo "export POCS=/var/panoptes/POCS" >> /home/panoptes/.zshrc
  # Setup hardware watchdog
  - sudo echo 'watchdog-device = /dev/watchdog' >> /etc/watchdog.conf
  - sudo echo 'watchdog-timeout = 15' >> /etc/watchdog.conf
  - sudo echo 'max-load-1 = 24' >> /etc/watchdog.conf
  - echo 'interface = eth0' >> /etc/watchdog.conf
  - echo 'interface = wlan0' >> /etc/watchdog.conf
  # Install POCS
  - cd /var/panoptes
  - sh -c "$(wget -q -O- https://intall.projectpanoptes.org)"

# example of how to setup cronjobs
#write_files:
#  - content: |
#      0 13 * * 0 panoptes /script-to-run
#    path: /etc/crontab
#    append: true

power_state:
  mode: reboot
  condition: True

final_message: Welcome to the PANOPTES Observatory CONTROL System!
