options:
  substitutionOption: ALLOW_LOOSE
  machineType: E2_HIGHCPU_32
  env:
    - "DOCKER_CLI_EXPERIMENTAL=enabled"
timeout: 18000s  # 5 hours; arm is slow

substitutions:
  _IMAGE_NAME: panoptes-pocs
  _PLATFORM: linux/arm64,linux/amd64

steps:
  # Set up multiarch support
  - name: "gcr.io/cloud-builders/docker"
    id: "setup-buildx"
    args:
      - "run"
      - "--privileged"
      - "--rm"
      - "docker/binfmt:a7996909642ee92942dcd6cff44b9b95f08dad64"
    waitFor: [ "-" ]

  # Build builder
  - name: "gcr.io/cloud-builders/docker"
    id: "build-builder"
    args:
      - "buildx"
      - "create"
      - "--name=build"
      - "--use"
      - "--driver=docker-container"
    waitFor: [ "setup-buildx" ]

  # Build the image.
  - name: "gcr.io/cloud-builders/docker"
    id: "build-images"
    args:
      - "buildx"
      - "build"
      - "--platform=${_PLATFORM}"
      - "-f=docker/Dockerfile"
      - "--tag=gcr.io/${PROJECT_ID}/${_IMAGE_NAME}:${TAG_NAME}"
      - "--push"
      - "."
    waitFor: [ "build-builder" ]
