#!/usr/bin/bash
set -e

PARAMS="$*"

export PANDIR=${PANDIR:-/var/panoptes}
export IMAGE="${IMAGE:-panoptes-pocs}"
export TAG="${TAG:-developer-env}"
export CONTAINER_NAME="${CONTAINER_NAME:-pocs-developer-env}"

cd "${PANDIR}"

CMD="docker-compose \
    --project-directory ${PANDIR} \
    --env-file ${PANDIR}/env \
    -f POCS/docker/docker-compose-developer-env.yaml \
    -p panoptes"

## Add the deamon option by default.
if [[ "$PARAMS" == "up" ]]; then
    PARAMS="up -d"
fi

# We use a docker container for docker-compose, so we need to pass the env vars to
# that container so it can properly place them in the docker-compose file.
export DOCKER_RUN_OPTIONS="${DOCKER_RUN_OPTIONS:--e IMAGE=${IMAGE} -e TAG=${TAG} -e CONTAINER_NAME=${CONTAINER_NAME}}"

# Run the docker-compose command with user params.
eval "DOCKER_RUN_OPTIONS=\"${DOCKER_RUN_OPTIONS}\" ${CMD} ${PARAMS}"

# If we just started the environment, try to open the browser for the user.
if [[ "$PARAMS" == "up -d" ]]; then
    # Prompt for password
    "${PANDIR}/POCS/bin/wait-for-it.sh" \
        localhost:8888 \
        -- \
        docker exec -it -u panoptes "${CONTAINER_NAME}" jupyter notebook list | grep http | cut -d ' ' -f 1 | xargs xdg-open
fi
