#!/bin/bash -ie

usage() {
  echo -n "##################################################
# Start POCS via Docker.
#
##################################################

 $ $(basename $0) [COMMAND]

 Options:
  COMMAND 	These options are passed at the end of the docker-compose command.
  			To start all service simply pass 'up'.

 Examples:

	# Start all services in the foreground.
	$POCS/scripts/pocs-docker.sh up

 	# Start config-server and messaging-hub serivces in the background.
	$POCS/scripts/pocs-docker.sh up --no-deps -d config-server messaging-hub

 	# Read the logs from the config-server
	$POCS/scripts/pocs-docker.sh logs config-server

    # Run the software tests (no hardware)
    $POCS/scripts/pocs-docker.sh up
"
}

START=${1:-help}
if [ "${START}" = 'help' ] || [ "${START}" = '-h' ] || [ "${START}" = '--help' ]; then
	usage
	exit 1
fi

if [ "$(docker ps -q -f name="pocs-shell")" ] || [ "$(docker ps -q -f name="peas-shell")" ] || [ "$(docker ps -q -f name="messaging-hub")" ] || [ "$(docker ps -q -f name="config-server")" ] || [ "$(docker ps -q -f name="aag-weather-reader")" ] || [ "$(docker ps -q -f name="aag-weather-server")" ]; then
	echo "At least one PANOPTES docker container is already running! Manually stop docker containers with docker stop <container name> if needed."
	echo "If an single docker container needs to be started do so with bin/pocs up --no-deps <container name>."
        exit 1
fi

cd "$PANDIR"
docker-compose \
   --project-directory "${PANDIR}" \
        -f panoptes-utils/docker/docker-compose.yaml \
        -f PAWS/docker/docker-compose.yaml \
        -f POCS/docker/docker-compose.yaml \
                -p panoptes "$@"
